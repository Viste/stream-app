{% extends 'layout.html' %}

{% block content %}
<div class="container">
    <h2>Онлайн Трансляции</h2>
    {% if live_broadcasts %}
    <div class="row">
        {% for broadcast in live_broadcasts %}
        <div class="col-md-{{ 12 // live_broadcasts|length }}">
            <h3>{{ broadcast.course.name }}</h3>
            <div id="dplayer-{{ loop.index }}" class="video" style="width: 100%;"></div>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var dp = new DPlayer({
                        container: document.getElementById('dplayer-{{ loop.index }}'),
                        video: {
                            quality: [
                                {name: 'HD', url: 'https://live.pprfnk.tech/hls/{{ broadcast.course.short_name }}/index.m3u8', type: 'hls'},
                                {name: '720p', url: 'https://live.pprfnk.tech/hls/{{ broadcast.course.short_name }}/index_720p2628kbs.m3u8', type: 'hls'},
                                {name: '480p', url: 'https://live.pprfnk.tech/hls/{{ broadcast.course.short_name }}/index_480p1128kbs.m3u8', type: 'hls'},
                                {name: '360p', url: 'https://live.pprfnk.tech/hls/{{ broadcast.course.short_name }}/index_360p878kbs.m3u8', type: 'hls'},
                                {name: '240p', url: 'https://live.pprfnk.tech/hls/{{ broadcast.course.short_name }}/index_240p528kbs.m3u8', type: 'hls'}
                            ],
                            preload: 'auto',
                            autoplay: false,
                            defaultQuality: 0,
                            pic: 'PATH_TO_PREVIEW_IMAGE_IF_NEEDED'
                        },
                        hlsjsConfig: {
                            // hls.js specific options
                            startLevel: 0,
                            autoStartLoad: true,
                            maxBufferLength: 5, // Уменьшение максимальной длины буфера
                            maxMaxBufferLength: 10, // Максимальная длина буфера, которую `hls.js` будет поддерживать
                            liveSyncDurationCount: 1, // Уменьшение количества сегментов, необходимых для начала воспроизведения
                            liveMaxLatencyDurationCount: 2, // Максимальное количество сегментов, которое может отставать от реального времени
                            capLevelToPlayerSize: true
                        }
                    });
                });
            </script>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>В данный момент нет активных трансляций.</p>
    {% endif %}

    <h2>Доступные Курсы</h2>
    <div class="row">
        {% for course in courses %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <h3 class="card-title">{{ course.name }}</h3>
                    <p class="card-text">{{ course.description }}</p>
                    <a href="{{ url_for('course_page', short_name=course.short_name) }}" class="btn btn-primary mt-auto">Подробнее</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
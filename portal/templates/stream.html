{% extends 'layout.html' %}

{% block content %}
<div class="container">
    <h2>Онлайн Трансляции</h2>
    {% if live_broadcasts %}
    <div class="row">
        {% for broadcast in live_broadcasts %}
        <div class="col-md-{{ 12 // live_broadcasts|length }}">
            <h3>{{ broadcast.course.name }}</h3>
            <video id="live_video_{{ loop.index }}" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" width="640" height="360">
                <source src="https://live.pprfnk.tech/hls/{{ broadcast.course.short_name }}/index.m3u8" type="application/x-mpegURL">
            </video>
            <div>Live</div> <!-- Отображение статуса Live -->
            <div id="viewers_count_{{ loop.index }}">Зрителей: загрузка...</div> <!-- Счетчик зрителей -->
            <script>
                var player{{ loop.index }} = videojs('live_video_{{ loop.index }}');
                player{{ loop.index }}.play();
            </script>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>В данный момент нет активных трансляций.</p>
    {% endif %}
</div>

<script>
function updateViewers() {
    {% for broadcast in live_broadcasts %}
    fetch('https://live.pprfnk.tech/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('viewers_count_{{ loop.index }}').textContent = 'Зрителей: ' + data.viewers;
        })
        .catch(error => console.error('Ошибка при получении данных о зрителях:', error));
    {% endfor %}
}

setInterval(updateViewers, 5000); // Обновление каждые 5 секунд
</script>
{% endblock %}